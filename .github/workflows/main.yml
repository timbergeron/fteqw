name: main

on: [ push, pull_request, workflow_dispatch ]

jobs:
  cmake:
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        profile: [ "Debug", "Release" ]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Get number of CPU cores
        uses: SimenB/github-actions-cpu-cores@v2
        id: cpu-cores

      - uses: actions/checkout@v4

      - name: "Install Dependencies"
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install --no-install-recommends              \
            gettext                                                     \
            libasound2-dev                                              \
            libbullet-dev                                               \
            libgnutls28-dev                                             \
            libopenxr-dev                                               \
            libqscintilla2-qt5-dev                                      \
            libsdl2-dev                                                 \
            libpng-dev                                                  \
            libvorbis-dev                                               \
            libvulkan-dev                                               \
            libwayland-dev                                              \
            libxcursor-dev                                              \
            libxkbcommon-dev                                            \
            libxrandr-dev                                               \
            qtbase5-dev

            # Disabled due to warnings that break the debug build with -Werror
            # libode-dev
            # libavcodec-dev libavformat-dev libavutil-dev libswscale-dev

      - name: "Configure: ${{ matrix.profile }}"
        run: |
          cmake -B build_${{ matrix.profile }} -DCMAKE_BUILD_TYPE=${{ matrix.profile }}

      - name: "Build: ${{ matrix.profile }}"
        run: |
          cmake --build build_${{ matrix.profile }} --parallel ${{ steps.cpu-cores.outputs.count }}

      # upload build_Release artifacts ONLY for ubuntu-latest Release on push
      - name: Get version
        if: github.event_name == 'push' && matrix.os == 'ubuntu-latest' && matrix.profile == 'Release'
        id: version
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Upload Release artifacts (cmake)
        if: github.event_name == 'push' && matrix.os == 'ubuntu-latest' && matrix.profile == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: cmake-ubuntu-release-${{ steps.version.outputs.short_sha }}
          path: |
            build_Release/**
            !build_Release/**/CMakeFiles/**
            !build_Release/**/CMakeCache.txt
            !build_Release/**/*.o
          compression-level: 9
          retention-days: 14

  make:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: web
            fte_target: web
            make_targets: "gl-rel"
            os: ubuntu-latest
          - name: linux64
            fte_target: linux64
            make_targets: "m-rel sv-rel qtv-rel qcc-rel"
            os: ubuntu-latest
            packages: "libpng-dev libasound2-dev libgl-dev libegl1-mesa-dev libwayland-dev libxcursor-dev libxi-dev libxkbcommon-dev libxrandr-dev libxss-dev"
          - name: win32
            fte_target: win32
            make_targets: "m-rel sv-rel qcc-rel"
            os: ubuntu-latest
            packages: "binutils-mingw-w64-i686 gcc-mingw-w64-i686 g++-mingw-w64-i686"
          - name: win64
            fte_target: win64
            make_targets: "m-rel sv-rel qcc-rel"
            os: ubuntu-latest
            packages: "binutils-mingw-w64-x86-64 gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64"
          - name: macos-arm64
            fte_target: SDL2
            make_targets: "gl-rel sv-rel qcc-rel"
            # IMPORTANT CHANGE:
            # ARCH=arm was making the build try to cross-compile 32-bit "arm"
            # and that blew up ogg/vorbis headers (no stdint types).
            # On Apple Silicon runners we want arm64, not 32-bit arm.
            args: "ARCH=arm64 STRIPFLAGS="
            packages: "sdl2 openssl@3 pkg-config"
            os: macos-14

    name: make-${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
      - name: Get number of CPU cores
        uses: SimenB/github-actions-cpu-cores@v2
        id: cpu-cores

      - uses: actions/checkout@v4

      - name: Extract versions
        run: grep 'VER=' engine/Makefile | tee makelibs_versions

      # cache the prebuilt libs-<arch> (best effort, don't die if cache svc is cranky)
      - uses: actions/cache@v4
        id: cache
        continue-on-error: true
        with:
          path: engine/libs-*
          key: ${{ runner.os }}-${{ matrix.fte_target }}-${{ hashFiles('makelibs_versions') }}

      # set up emscripten for the web target
      - uses: mymindstorm/setup-emsdk@v14
        if: matrix.fte_target == 'web'
        continue-on-error: true
        with:
          version: "2.0.12"
          actions-cache-folder: "emsdk-cache-2.0.12"
          cache-key: "emsdk-2.0.12"

      - name: Verify emscripten
        if: matrix.fte_target == 'web'
        run: emcc -v

      # Linux deps (only if we actually defined packages)
      - name: Install dependencies (linux)
        if: matrix.packages && matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install --no-install-recommends ${{ matrix.packages }}

      # macOS deps + toolchain env
      - name: Install dependencies (macOS)
        if: matrix.packages && (matrix.os == 'macos-14' || matrix.os == 'macos-latest')
        run: |
          brew install ${{ matrix.packages }}

      - name: Set up macOS build env
        if: matrix.os == 'macos-14' || matrix.os == 'macos-latest'
        run: |
          echo "BREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix)/opt/openssl@3/lib/pkgconfig:$(brew --prefix)/lib/pkgconfig" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix)/opt/openssl@3/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix)/opt/openssl@3/lib" >> $GITHUB_ENV
          echo "SDKROOT=$(xcrun --sdk macosx --show-sdk-path)" >> $GITHUB_ENV

      - name: Verify macOS toolchain
        if: matrix.os == 'macos-14' || matrix.os == 'macos-latest'
        run: |
          pkg-config --cflags --libs sdl2
          pkg-config --cflags --libs openssl || true
          echo "ARCH args: ${{ matrix.args }}"

      # build 3rd-party libs only if cache miss
      - name: Build dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        working-directory: engine
        run: |
          make FTE_TARGET=${{ matrix.fte_target }} makelibs ${{ matrix.args }}

      - uses: ammaraskar/gcc-problem-matcher@0.3.0

      # main build
      - name: Build ${{ matrix.name }}
        working-directory: engine
        run: |
          make -j ${{ steps.cpu-cores.outputs.count }} \
            FTE_TARGET=${{ matrix.fte_target }} \
            ${{ matrix.make_targets }} \
            ${{ matrix.args }} \
            LINK_EZHUD=1 \
            LINK_OPENSSL=1

      # macOS readme helper
      - name: Attach macOS docs
        if: matrix.os == 'macos-14' || matrix.os == 'macos-latest'
        run: |
          cat <<EOF > engine/release/fte_macos.txt
          To allow executables to run issue for example:
          chmod +x fteqw-glsdl2
          xattr -d com.apple.quarantine fteqw-glsdl2

          If you don't have SDL2 installed, run:
          brew install sdl2
          EOF

      - name: Get version
        id: version
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fteqw-${{ matrix.name }}-${{ steps.version.outputs.short_sha }}
          path: |
            engine/release/fte*
            !engine/release/*.db
          compression-level: 9

  fteqcc-macos:
    name: fteqcc-macos
    runs-on: macos-14
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Get number of CPU cores
        uses: SimenB/github-actions-cpu-cores@v2
        id: cpu-cores

      - name: Build fteqcc
        working-directory: engine/qclib
        run: |
          make clean_bins
          MAKEFLAGS="-j ${{ steps.cpu-cores.outputs.count }}" make universal

      - name: Get version
        id: version
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Upload fteqcc artifact
        uses: actions/upload-artifact@v4
        with:
          name: fteqcc-macos-universal-${{ steps.version.outputs.short_sha }}
          path: |
            engine/qclib/fteqcc
            engine/qclib/fteqcc.arm64
            engine/qclib/fteqcc.x64
          compression-level: 9
